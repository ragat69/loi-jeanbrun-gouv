# ==================================================
# Loi Jeanbrun - Configuration Apache
# ==================================================

# Activer le moteur de rewriting
RewriteEngine On

# Base du rewriting
RewriteBase /

# ==================================================
# Forcer HTTPS (uniquement en production)
# ==================================================
# Exclure les domaines locaux (.test, .local, localhost)
RewriteCond %{HTTPS} off
RewriteCond %{HTTP_HOST} !\.test$ [NC]
RewriteCond %{HTTP_HOST} !\.local$ [NC]
RewriteCond %{HTTP_HOST} !^localhost [NC]
RewriteRule ^(.*)$ https://%{HTTP_HOST}/$1 [R=301,L]

# ==================================================
# Forcer la version sans www (et HTTPS en prod)
# ==================================================
RewriteCond %{HTTP_HOST} ^www\.(.+)$ [NC]
RewriteCond %{HTTP_HOST} !\.test$ [NC]
RewriteCond %{HTTP_HOST} !\.local$ [NC]
RewriteRule ^(.*)$ https://%1/$1 [R=301,L]

# ==================================================
# Supprimer l'extension .php des URLs
# ==================================================

# Si l'utilisateur accede a un fichier .php, rediriger vers l'URL sans extension
RewriteCond %{THE_REQUEST} \s/([^.]+)\.php[\s?] [NC]
RewriteRule ^ /%1 [R=301,L]

# Si l'URL sans extension correspond a un fichier .php existant, le servir
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_FILENAME}\.php -f
RewriteRule ^(.+)$ $1.php [L]

# ==================================================
# Blog (Actualit√©s) Routing
# ==================================================

# Blog homepage
RewriteRule ^actualites/?$ actualites/index.php [L]

# Blog pagination: /actualites/page-2
RewriteRule ^actualites/page-([0-9]+)/?$ actualites/index.php?page=$1 [L,QSA]

# Blog article: /actualites/2026-07-23/article-slug
RewriteRule ^actualites/([0-9]{4}-[0-9]{2}-[0-9]{2})/([a-z0-9-]+)/?$ actualites/article.php?date=$1&slug=$2 [L,QSA]

# ==================================================
# Pages d'erreur personnalisees (optionnel)
# ==================================================
ErrorDocument 404 /index.php
ErrorDocument 500 /index.php

# ==================================================
# Securite supplementaire
# ==================================================

# Bloquer l'acces aux fichiers sensibles
<FilesMatch "^\.">
    Order allow,deny
    Deny from all
</FilesMatch>

# Bloquer l'acces au dossier includes
<IfModule mod_rewrite.c>
    RewriteRule ^includes/ - [F,L]
</IfModule>

# Desactiver l'affichage du contenu des repertoires
Options -Indexes

# Protection contre le clickjacking
<IfModule mod_headers.c>
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-XSS-Protection "1; mode=block"
</IfModule>
